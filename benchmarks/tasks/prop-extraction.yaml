# Prop Extraction Benchmark
# Evaluates models on extracting structured prop data from a screenplay.
# Mirrors CineForge's prop_bible_v1 module.
#
# Usage: cd benchmarks && promptfoo eval -c tasks/prop-extraction.yaml --no-cache -j 3
# View:  promptfoo view

description: "Prop extraction from screenplay — The Mariner"

defaultTest:
  options:
    provider: anthropic:messages:claude-opus-4-6

prompts:
  - file://../prompts/prop-extraction.txt

providers:
  # --- Cheap tier ---
  - id: openai:gpt-4.1-nano
    label: "GPT-4.1 Nano"
    config:
      temperature: 0
      max_tokens: 4096
      response_format: { type: "json_object" }

  - id: openai:gpt-4.1-mini
    label: "GPT-4.1 Mini"
    config:
      temperature: 0
      max_tokens: 4096
      response_format: { type: "json_object" }

  - id: google:gemini-2.5-flash-lite
    label: "Gemini 2.5 Flash Lite"
    config:
      temperature: 0
      maxOutputTokens: 16384

  # --- Mid tier ---
  - id: openai:gpt-4.1
    label: "GPT-4.1"
    config:
      temperature: 0
      max_tokens: 4096
      response_format: { type: "json_object" }

  - id: anthropic:messages:claude-haiku-4-5-20251001
    label: "Claude Haiku 4.5"
    config:
      temperature: 0
      max_tokens: 4096

  - id: anthropic:messages:claude-sonnet-4-5-20250929
    label: "Claude Sonnet 4.5"
    config:
      temperature: 0
      max_tokens: 4096

  - id: anthropic:messages:claude-sonnet-4-6
    label: "Claude Sonnet 4.6"
    config:
      temperature: 0
      max_tokens: 4096

  - id: google:gemini-2.5-flash
    label: "Gemini 2.5 Flash"
    config:
      temperature: 0
      maxOutputTokens: 16384

  - id: google:gemini-3-flash-preview
    label: "Gemini 3 Flash"
    config:
      temperature: 0
      maxOutputTokens: 16384

  # --- SOTA tier ---
  - id: openai:gpt-5.2
    label: "GPT-5.2"
    config:
      temperature: 0
      max_tokens: 4096
      response_format: { type: "json_object" }

  - id: anthropic:messages:claude-opus-4-6
    label: "Claude Opus 4.6"
    config:
      temperature: 0
      max_tokens: 4096

  - id: google:gemini-2.5-pro
    label: "Gemini 2.5 Pro"
    config:
      temperature: 0
      maxOutputTokens: 16384

  - id: google:gemini-3-pro-preview
    label: "Gemini 3 Pro"
    config:
      temperature: 0
      maxOutputTokens: 16384

tests:
  # Test 1: OAR — primary weapon, identity symbol, BOSUN carving
  - vars:
      prop_name: "OAR"
      screenplay: file://../input/the-mariner.md
      golden_path: golden/the-mariner-props.json
    assert:
      - type: python
        value: file://../scorers/bible_extraction_scorer.py
      - type: llm-rubric
        value: |
          Evaluate the prop extraction for the OAR (BOSUN) from "The Mariner."

          Key quality criteria:
          1. Does it describe the oar as stout, wooden, edged with metal?
          2. Does it mention the word "BOSUN" carved into the wood?
          3. Does it identify this as Mariner's primary melee weapon?
          4. Does it note the oar is dripping with blood throughout the story?
          5. Does it capture the maritime/fisherman symbolism connecting to his father?
          6. Does it mention the oar being taken from Mariner before the final confrontation?
          7. Does it connect the prop to Mariner's constructed identity?

          Score strictly: the oar is the most important prop and a symbol of Mariner's entire identity.

  # Test 2: PURSE — MacGuffin, blockchain password, plot driver
  - vars:
      prop_name: "PURSE"
      screenplay: file://../input/the-mariner.md
      golden_path: golden/the-mariner-props.json
    assert:
      - type: python
        value: file://../scorers/bible_extraction_scorer.py
      - type: llm-rubric
        value: |
          Evaluate the prop extraction for ROSE'S PURSE from "The Mariner."

          Key quality criteria:
          1. Does it identify the purse as belonging to Rose?
          2. Does it mention the hidden chip in the purse lining?
          3. Does it explain the blockchain password accessing $20 million in cryptocurrency?
          4. Does it note that Rose stole this money from Salvatori's gang?
          5. Does it identify the purse as the primary MacGuffin driving the second half?
          6. Does it mention Rose going back into danger to retrieve it from the 15th floor?
          7. Does it capture how the purse reveals Rose's true mission vs. Mariner's rescue?

          Score strictly: the purse is the central plot device and must be understood as more than a simple object.

  # Test 3: FLARE GUN — maritime weapon, absurd/effective contrast
  - vars:
      prop_name: "FLARE GUN"
      screenplay: file://../input/the-mariner.md
      golden_path: golden/the-mariner-props.json
    assert:
      - type: python
        value: file://../scorers/bible_extraction_scorer.py
      - type: llm-rubric
        value: |
          Evaluate the prop extraction for the FLARE GUN from "The Mariner."

          Key quality criteria:
          1. Does it describe the flare gun as a fat, bright-orange pistol?
          2. Does it mention the thugs mocking it before it is fired?
          3. Does it describe the scene where Mariner shoots Vinnie on the 13th floor?
          4. Does it note the blinding red flare and horror-movie lighting effect?
          5. Does it connect the flare gun to Mariner's maritime-themed arsenal?
          6. Does it capture the absurd/effective contrast — looks ridiculous but is lethal?
          7. Is evidence grounded in actual screenplay text?

          Score strictly: a good extraction captures both the physical description and the thematic contrast.
